<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>課程協議簽署 | 艾瑞克農地投資實戰班</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background: #f4f6f9; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 650px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); overflow: hidden; }
        
        /* 標題區 */
        .header { background: #2c3e50; color: white; padding: 30px 20px; text-align: center; }
        .header h2 { margin: 0; font-size: 24px; letter-spacing: 1px; }
        .header p { margin: 8px 0 0; font-size: 14px; opacity: 0.8; }

        .content { padding: 30px 25px; }

        /* 進度條 */
        .steps { display: flex; justify-content: center; margin-bottom: 30px; position: relative; }
        .step { z-index: 1; background: #fff; padding: 0 15px; color: #ccc; font-weight: bold; font-size: 15px; }
        .step.active { color: #2c3e50; border-bottom: 2px solid #2c3e50; }
        .step-line { position: absolute; top: 50%; left: 20%; right: 20%; height: 1px; background: #ddd; z-index: 0; }

        /* 表單元件 */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 16px; box-sizing: border-box; transition: 0.3s; }
        input:focus { border-color: #2c3e50; outline: none; box-shadow: 0 0 0 3px rgba(44,62,80,0.1); }
        
        .hidden { display: none; }

        /* 合約預覽區 */
        #contractPreview {
            height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            padding: 25px;
            background: #fff;
            margin-bottom: 25px;
            border-radius: 6px;
            font-size: 15px;
            line-height: 1.8;
            color: #222;
        }
        
        /* 避免 Google Doc 匯出的樣式跑版 */
        #contractPreview p { margin-bottom: 12px; }
        
        /* 自動填入文字的高亮樣式 */
        .user-data-highlight {
            background-color: #fff3cd;
            color: #856404;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
            border-bottom: 1px solid #ffeeba;
        }

        /* 簽名板 */
        .sig-container { border: 2px dashed #bdc3c7; border-radius: 8px; position: relative; height: 220px; background: #fff; }
        canvas { width: 100%; height: 100%; display: block; }
        .clear-btn { position: absolute; bottom: 10px; right: 10px; background: #f1f1f1; border: 1px solid #ddd; padding: 6px 12px; border-radius: 4px; cursor: pointer; color: #666; font-size: 13px; }
        .clear-btn:hover { background: #e0e0e0; }

        /* 按鈕 */
        .btn { width: 100%; padding: 15px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-primary:hover { background: #2980b9; }
        .btn-success { background: #27ae60; color: white; }
        .btn-success:hover { background: #219150; }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; }

        .back-link { display: block; text-align: center; margin-top: 15px; color: #95a5a6; cursor: pointer; font-size: 14px; text-decoration: none;}
        .back-link:hover { color: #2c3e50; text-decoration: underline; }

        .loading-text { text-align: center; color: #7f8c8d; padding: 40px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h2>艾瑞克農地投資實戰班</h2>
        <p>課程保密協議簽署系統</p>
    </div>

    <div class="content">
        <div class="steps">
            <div class="step-line"></div>
            <span class="step active" id="step1-indicator">1. 填寫資料</span>
            <span class="step" id="step2-indicator">2. 審閱與簽署</span>
        </div>

        <div id="step1">
            <div class="form-group">
                <label for="inputName">真實姓名</label>
                <input type="text" id="inputName" placeholder="請輸入您的真實姓名 (用於合約)">
            </div>
            <div class="form-group">
                <label for="inputId">身分證字號</label>
                <input type="text" id="inputId" placeholder="請輸入身分證字號">
            </div>
            <div class="form-group">
                <label for="inputPhone">聯絡電話</label>
                <input type="tel" id="inputPhone" placeholder="09xx-xxx-xxx">
            </div>
            <div class="form-group">
                <label for="inputEmail">電子信箱 (接收合約副本)</label>
                <input type="email" id="inputEmail" placeholder="example@gmail.com">
            </div>
            <button class="btn btn-primary" onclick="goToStep2()">下一步：審閱合約</button>
        </div>

        <div id="step2" class="hidden">
            <div class="form-group">
                <label>請詳閱合約內容 (您的資料已自動帶入)</label>
                <div id="contractPreview">
                    <div class="loading-text">
                        <p>正在與伺服器連線取得合約...</p>
                        <small>若載入過久，請重新整理頁面</small>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label>請在下方框線內簽名</label>
                <div class="sig-container">
                    <canvas id="signature-pad"></canvas>
                    <button type="button" class="clear-btn" onclick="clearSig()">清除重簽</button>
                </div>
            </div>

            <button class="btn btn-success" id="submitBtn" onclick="submitContract()">本人已詳閱並同意簽署</button>
            <div class="back-link" onclick="backToStep1()">← 返回修改資料</div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // 設定區
    // ==========================================
    // 你的 Google Apps Script 部署網址
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyXa8gNot0m3sJsVQ8qO4uYKBA0pbv8wTVz8XFEVialgpQPFtOitR60NvIPLdyUdjc/exec";

    // ==========================================
    // 邏輯區
    // ==========================================
    let rawContractHTML = "";
    const canvas = document.getElementById('signature-pad');
    const signaturePad = new SignaturePad(canvas);

    // 1. 初始化：網頁打開時，偷偷先去抓合約內容
    window.onload = function() {
        resizeCanvas();
        fetchContractContent();
    };

    // 從後端抓取 Google Doc 的 HTML
    function fetchContractContent() {
        fetch(GAS_URL)
        .then(res => res.json())
        .then(data => {
            rawContractHTML = data.content;
            console.log("合約內容載入成功");
            // 如果這時候使用者還沒切到 Step 2，就只存起來不動作
            // 如果已經在 Step 2 (很少見)，則直接更新
        })
        .catch(err => {
            console.error(err);
            document.getElementById('contractPreview').innerHTML = 
                '<p style="color:red; text-align:center; padding:20px;">合約載入失敗。<br>請檢查網路連線，或重新整理頁面。</p>';
        });
    }

    // 2. 切換到第二步
    function goToStep2() {
        // 取得輸入值
        const name = document.getElementById('inputName').value.trim();
        const id = document.getElementById('inputId').value.trim();
        const phone = document.getElementById('inputPhone').value.trim();
        const email = document.getElementById('inputEmail').value.trim();

        // 簡單驗證
        if(!name || !id || !phone || !email) {
            Swal.fire({
                icon: 'warning',
                title: '資料不完整',
                text: '請填寫所有欄位，以便生成合約。'
            });
            return;
        }

        // 檢查合約是否已載入
        if(!rawContractHTML) {
            Swal.fire("系統讀取中", "正在下載合約內容，請稍等 3 秒後再試...", "info");
            fetchContractContent();
            return;
        }

        // --- 核心：變數替換邏輯 ---
        let processedHTML = rawContractHTML;
        
        // 使用正則表達式全域替換 (/g)，並加上底色樣式
        processedHTML = processedHTML.replace(/{{name}}/g, `<span class="user-data-highlight">${name}</span>`);
        processedHTML = processedHTML.replace(/{{id}}/g, `<span class="user-data-highlight">${id}</span>`);
        processedHTML = processedHTML.replace(/{{phone}}/g, `<span class="user-data-highlight">${phone}</span>`);
        
        // 日期替換
        const now = new Date();
        processedHTML = processedHTML.replace(/{{sign_year}}/g, now.getFullYear());
        processedHTML = processedHTML.replace(/{{sign_month}}/g, now.getMonth() + 1);
        processedHTML = processedHTML.replace(/{{sign_day}}/g, now.getDate());

        // 渲染 HTML 到預覽框
        document.getElementById('contractPreview').innerHTML = processedHTML;

        // 切換介面顯示
        document.getElementById('step1').classList.add('hidden');
        document.getElementById('step2').classList.remove('hidden');
        document.getElementById('step1-indicator').classList.remove('active');
        document.getElementById('step2-indicator').classList.add('active');
        
        // 重新調整 Canvas 大小 (因為原本隱藏時寬度是0)
        resizeCanvas();
    }

    // 返回第一步
    function backToStep1() {
        document.getElementById('step1').classList.remove('hidden');
        document.getElementById('step2').classList.add('hidden');
        document.getElementById('step1-indicator').classList.add('active');
        document.getElementById('step2-indicator').classList.remove('active');
    }

    // 3. 送出簽署 (POST)
    function submitContract() {
        if (signaturePad.isEmpty()) {
            Swal.fire("尚未簽名", "請在虛線框內簽上您的姓名。", "warning");
            return;
        }

        // 鎖定按鈕
        const btn = document.getElementById('submitBtn');
        btn.disabled = true;
        btn.textContent = "正在製作合約並歸檔，請稍候...";

        // 打包資料
        const data = {
            name: document.getElementById('inputName').value,
            id: document.getElementById('inputId').value,
            phone: document.getElementById('inputPhone').value,
            email: document.getElementById('inputEmail').value,
            signature: signaturePad.toDataURL() // 簽名圖片 Base64
        };

        // 發送
        fetch(GAS_URL, {
            method: "POST",
            body: JSON.stringify(data),
            mode: "no-cors", // 跨域傳輸必備設定
            headers: { "Content-Type": "text/plain" }
        })
        .then(() => {
            // 因 no-cors 無法接收回傳值，預設為成功
            Swal.fire({
                icon: 'success',
                title: '簽署完成！',
                text: '合約副本將寄至您的信箱，感謝您的配合。',
                confirmButtonText: '關閉'
            }).then(() => {
                location.reload(); // 重整頁面讓下一位使用者填寫
            });
        })
        .catch(err => {
            console.error(err);
            Swal.fire("錯誤", "連線發生問題，請檢查網路或稍後再試。", "error");
            btn.disabled = false;
            btn.textContent = "本人已詳閱並同意簽署";
        });
    }

    // Canvas 尺寸處理 (RWD)
    function clearSig() { signaturePad.clear(); }
    function resizeCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        canvas.height = canvas.offsetHeight * ratio;
        canvas.getContext("2d").scale(ratio, ratio);
        signaturePad.clear();
    }
    window.addEventListener("resize", resizeCanvas);
</script>

</body>
</html>
